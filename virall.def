Bootstrap: docker
From: ubuntu:22.04

%files
    # Note: virall Python package is NOT copied into the container
    # All Nextflow plotting functionality is self-contained in nextflow/bin/run_plots.py
    # This simplifies the container and avoids version sync issues

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/envs/virall/bin:/opt/conda/bin:$PATH
    export CONDA_PREFIX=/opt/conda/envs/virall
    export LD_LIBRARY_PATH=/opt/conda/envs/virall/lib:$LD_LIBRARY_PATH
    export LC_ALL=C
    export LANG=C.UTF-8
    # Set default database directory for the container
    export VIRALL_DATABASE_DIR=/opt/virall/databases
    # geNomad database path
    export GENOMAD_DB=/opt/virall/databases/genomad_db

%post
    # Set environment variables
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/bin:$PATH
    export LC_ALL=C
    export LANG=C.UTF-8

    # Check initial disk space
    echo "=== Initial disk space check ==="
    df -h

    # Update system and install basic dependencies
    apt-get update && apt-get install -y \
        wget \
        curl \
        bzip2 \
        ca-certificates \
        libcrypt1 \
        build-essential \
        gcc \
        g++ \
        make \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    cd /tmp
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh

    # Initialize conda
    /opt/conda/bin/conda init bash
    /opt/conda/bin/conda config --set auto_update_conda false
    /opt/conda/bin/conda config --set channel_priority flexible
    /opt/conda/bin/conda config --set remote_read_timeout_secs 300
    /opt/conda/bin/conda config --set remote_connect_timeout_secs 60
    /opt/conda/bin/conda config --set remote_max_retries 10

    # Accept conda Terms of Service
    /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main || true
    /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r || true

    # Create conda environment with Python 3.11
    /opt/conda/bin/conda create -n virall -y python=3.11

    # Set up conda environment variables
    export CONDA_PREFIX=/opt/conda/envs/virall
    export PATH=/opt/conda/bin:$CONDA_PREFIX/bin:$PATH

    # Use bash to activate conda environment and install packages
    # Install Python dependencies with conda
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c conda-forge -y \
        numpy \
        pandas \
        matplotlib \
        seaborn \
        plotly \
        biopython \
        scikit-learn \
        click \
        tqdm \
        pyyaml \
        loguru \
        psutil"

    # Install mamba for faster dependency solving
    echo "=== Checking disk space before installing mamba ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi
    
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c conda-forge mamba -y"
    
    echo "=== Checking disk space after installing mamba ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Upgrade libstdcxx-ng early to ensure all tools use the newer version with GLIBCXX_3.4.32
    # This is critical for tools like fastp that require GLIBCXX_3.4.32
    # Upgrading early ensures the symlink libstdc++.so.6 is created properly before any tools are installed
    echo "Upgrading libstdcxx-ng to ensure compatibility with all tools..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c conda-forge -y libstdcxx-ng" || echo "Warning: libstdcxx-ng upgrade failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    # Verify the symlink was created
    if [ ! -L "/opt/conda/envs/virall/lib/libstdc++.so.6" ] && [ -f "/opt/conda/envs/virall/lib/libstdc++.so.6.0.34" ]; then
        echo "Creating libstdc++.so.6 symlink..."
        ln -sf /opt/conda/envs/virall/lib/libstdc++.so.6.0.34 /opt/conda/envs/virall/lib/libstdc++.so.6 || true
    fi

    # Install bioinformatics tools using mamba
    # Install tools individually and clean cache frequently to avoid running out of space
    # This approach is more resilient to network issues and package extraction failures
    
    # Mapping/alignment tools - install individually
    echo "Installing samtools..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y samtools" || echo "Warning: samtools installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing bwa..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y bwa" || echo "Warning: bwa installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing minimap2..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y minimap2" || echo "Warning: minimap2 installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after mapping tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Assembly tools - install individually (these are large packages)
    echo "Installing SPAdes..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c conda-forge -c bioconda -y spades=4.2.0" || echo "Warning: SPAdes installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing Flye..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c conda-forge -c bioconda -y flye=2.9.6" || echo "Warning: Flye installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after assembly tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # QC tools - install individually
    # Use conda for fastp to avoid mamba hangs (mamba has GLIBCXX compatibility issues after libstdcxx upgrade)
    echo "Installing fastp..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastp" || echo "Warning: fastp installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    # Fix isa-l library for fastp (fastp needs libisal.so.2)
    # Find isa-l library and ensure it's accessible
    echo "Fixing isa-l library for fastp..."
    if [ -d "$CONDA_PREFIX/lib" ]; then
        # Find the actual isa-l library file (not symlinks)
        ISAL_LIB=$(find $CONDA_PREFIX -type f -name "libisal.so.2.*" 2>/dev/null | head -1)
        if [ -n "$ISAL_LIB" ]; then
            echo "Found isa-l library: $ISAL_LIB"
            ISAL_LIB_DIR=$(dirname "$ISAL_LIB")
            ISAL_LIB_FILE=$(basename "$ISAL_LIB")
            
            # Create symlinks pointing to the actual library file
            mkdir -p "$CONDA_PREFIX/lib"
            
            # Create libisal.so.2 -> libisal.so.2.0.31 (use full path for absolute symlink)
            if [ ! -L "$CONDA_PREFIX/lib/libisal.so.2" ]; then
                echo "Creating symlink: $CONDA_PREFIX/lib/libisal.so.2 -> $ISAL_LIB"
                if ln -sf "$ISAL_LIB" "$CONDA_PREFIX/lib/libisal.so.2"; then
                    echo "✓ Successfully created libisal.so.2 symlink"
                else
                    echo "✗ ERROR: Failed to create libisal.so.2 symlink"
                    exit 1
                fi
            else
                echo "Symlink libisal.so.2 already exists, checking if it's correct..."
                if [ "$(readlink -f "$CONDA_PREFIX/lib/libisal.so.2")" != "$ISAL_LIB" ]; then
                    echo "Warning: Existing symlink points to wrong location, recreating..."
                    rm -f "$CONDA_PREFIX/lib/libisal.so.2"
                    ln -sf "$ISAL_LIB" "$CONDA_PREFIX/lib/libisal.so.2" || exit 1
                fi
            fi
            
            # Verify the symlink was created correctly
            if [ -L "$CONDA_PREFIX/lib/libisal.so.2" ]; then
                echo "✓ Verified: libisal.so.2 symlink exists"
                ls -la "$CONDA_PREFIX/lib/libisal.so.2"
            else
                echo "✗ ERROR: libisal.so.2 symlink verification failed"
                exit 1
            fi
            
            # Create libisal.so -> libisal.so.2 (if needed)
            if [ ! -L "$CONDA_PREFIX/lib/libisal.so" ]; then
                echo "Creating symlink: $CONDA_PREFIX/lib/libisal.so -> libisal.so.2"
                ln -sf "libisal.so.2" "$CONDA_PREFIX/lib/libisal.so" || echo "Warning: Failed to create libisal.so symlink (non-critical)"
            fi
        else
            echo "Warning: isa-l library (libisal.so.2.*) not found. fastp may not work correctly."
        fi
    fi
    
    # Use conda for fastplong to avoid mamba segmentation faults (mamba crashes after libstdcxx upgrade)
    echo "Installing fastplong..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastplong=0.4.1" || echo "Warning: fastplong installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing fastqc..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y fastqc" || echo "Warning: fastqc installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after QC tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Other bioinformatics tools - install individually using conda instead of mamba
    # (mamba has GLIBCXX compatibility issues after libstdcxx upgrade)
    echo "Installing bcftools..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y bcftools gsl=2.6" || echo "Warning: bcftools installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing hmmer..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y hmmer" || echo "Warning: hmmer installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing prodigal..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y prodigal" || echo "Warning: prodigal installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing pilon..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y pilon" || echo "Warning: pilon installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing checkv and diamond (CheckV v1.2+ builds .dmnd from .faa)..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y checkv diamond" || echo "Warning: checkv/diamond installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing geNomad (for RNA viruses and eukaryotic DNA viruses)..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y genomad" || echo "Warning: genomad installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing kaiju..."
    # Install Kaiju 1.10.1 (includes kaiju-makedb) instead of default 1.4.4
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y 'kaiju=1.10.1'" || echo "Warning: kaiju installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing umi_tools (for single-cell sequencing support)..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y umi_tools" || echo "Warning: umi_tools installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing medaka (for Nanopore assembly polishing)..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y medaka" || echo "Warning: medaka installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    # Try to install minimap2 and fastqc with conda (they failed with mamba)
    echo "Retrying minimap2 with conda..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y minimap2" || echo "Warning: minimap2 installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Retrying fastqc with conda..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastqc" || echo "Warning: fastqc installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after all tool installations ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Fix OpenMPI libraries for SPAdes (needed for HMMER)
    if [ -d "$CONDA_PREFIX/lib" ]; then
        # Find OpenMPI libraries installed with SPAdes
        OPENMPI_LIB=$(find $CONDA_PREFIX -type f -name "libmpi.so.40*" 2>/dev/null | grep -E "libmpi\.so\.40$|libmpi\.so\.40\." | head -1)
        
        if [ -n "$OPENMPI_LIB" ]; then
            OPENMPI_LIB_DIR=$(dirname "$OPENMPI_LIB")
            # Link all OpenMPI libraries to environment lib directory
            # IMPORTANT: Only link actual files, not symlinks, and exclude libisal.so.2 which is handled separately
            mkdir -p "$CONDA_PREFIX/lib"
            for lib in "$OPENMPI_LIB_DIR"/*.so*; do
                if [ -f "$lib" ] && [ ! -L "$lib" ]; then
                    lib_name=$(basename "$lib")
                    # Skip libisal.so.2 - it's handled separately for fastp
                    if [ "$lib_name" != "libisal.so.2" ] && [ "$lib_name" != "libisal.so" ]; then
                        # Only create symlink if it doesn't already exist or is incorrect
                        if [ ! -L "$CONDA_PREFIX/lib/$lib_name" ] || [ "$(readlink -f "$CONDA_PREFIX/lib/$lib_name")" != "$lib" ]; then
                            ln -sf "$lib" "$CONDA_PREFIX/lib/$lib_name" 2>/dev/null || true
                        fi
                    fi
                fi
            done
        fi
    fi
    
    # Fix OpenBLAS libraries for numpy (numpy needs libopenblas.so.0)
    if [ -d "$CONDA_PREFIX/lib" ]; then
        # Find the actual OpenBLAS library file (not symlinks)
        OPENBLAS_LIB=$(find $CONDA_PREFIX -type f -name "libopenblas.so.0.*" 2>/dev/null | head -1)
        if [ -n "$OPENBLAS_LIB" ]; then
            OPENBLAS_LIB_DIR=$(dirname "$OPENBLAS_LIB")
            OPENBLAS_LIB_FILE=$(basename "$OPENBLAS_LIB")
            # Create symlinks pointing to the actual library file
            mkdir -p "$CONDA_PREFIX/lib"
            # Create libopenblas.so.0 -> libopenblas.so.0.x.x
            if [ ! -L "$CONDA_PREFIX/lib/libopenblas.so.0" ]; then
                ln -sf "$OPENBLAS_LIB_FILE" "$CONDA_PREFIX/lib/libopenblas.so.0" 2>/dev/null || true
            fi
            # Create libopenblas.so -> libopenblas.so.0 (if needed)
            if [ ! -L "$CONDA_PREFIX/lib/libopenblas.so" ]; then
                ln -sf "libopenblas.so.0" "$CONDA_PREFIX/lib/libopenblas.so" 2>/dev/null || true
            fi
        fi
    fi

    # Create SPAdes symlink
    SPADES_PATH=$(find $CONDA_PREFIX -name "spades.py" 2>/dev/null | head -1)
    if [ -n "$SPADES_PATH" ]; then
        ln -sf "$SPADES_PATH" "$CONDA_PREFIX/bin/spades"
    fi

    # Create directories for databases (to be populated at runtime or via bind mounts)
    mkdir -p /opt/virall/databases/vog_db
    mkdir -p /opt/virall/databases/kaiju_db
    mkdir -p /opt/virall/databases/checkv_db
    mkdir -p /opt/virall/databases/genomad_db
    
    # Create directory for virall source code
    # The source code should be copied into the container during build
    # using: singularity build --fakeroot virall.sif virall.def
    # with the source code in the same directory as the .def file
    mkdir -p /opt/virall/src

    # Final cleanup of conda cache (already cleaned after each tool, but do one more pass)
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Final disk space check after cleanup ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Note: virall Python package is NOT installed in the container
    # All Nextflow plotting functionality is self-contained in nextflow/bin/run_plots.py
    # This simplifies the container and avoids version sync issues
    
    # Fix numpy version for TensorFlow + numba/geNomad compatibility
    # TensorFlow requires numpy < 2.0, numba requires numpy < 2.4
    # numpy 1.26.x satisfies both requirements
    echo "Ensuring numpy version compatibility for TensorFlow and numba/geNomad..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && pip install 'numpy>=1.26.0,<2.0'" || echo "Warning: numpy version fix failed"

    # ========================================================================
    # Database Setup (included in image for easy cluster use, ~21GB total)
    # ========================================================================
    # Same as Dockerfile: VOG, Kaiju (viruses), CheckV baked in at /opt/virall/databases/
    
    echo "Setting up VOG (Viral Orthologous Groups) database..."
    VOG_DB_DIR="/opt/virall/databases/vog_db"
    mkdir -p "$VOG_DB_DIR"
    if [ ! -f "$VOG_DB_DIR/vog.hmm.h3m" ]; then
        echo "Downloading and setting up VOG database (this may take 5-10 minutes)..."
        export LD_LIBRARY_PATH="$CONDA_PREFIX/lib:${LD_LIBRARY_PATH:-}"
        cd "$VOG_DB_DIR" && \
            wget -q https://fileshare.lisc.univie.ac.at/vog/vog227/vog.hmm.tar.gz && \
            tar -xzf vog.hmm.tar.gz && rm -f vog.hmm.tar.gz && \
            ( [ -f AllVOG.hmm ] && cat AllVOG.hmm > vog.hmm && rm -f AllVOG.hmm ) || true && \
            ( [ -f vog.hmm ] && hmmpress vog.hmm ) || true
        cd - >/dev/null
    fi
    
    echo "Setting up Kaiju viral database..."
    KAIJU_DB_DIR="/opt/virall/databases/kaiju_db"
    mkdir -p "$KAIJU_DB_DIR"
    if [ -z "$(find "$KAIJU_DB_DIR" -maxdepth 2 -name '*.fmi' 2>/dev/null | head -1)" ]; then
        echo "Downloading Kaiju viral database (pre-built viruses subset)..."
        cd "$KAIJU_DB_DIR" && \
            wget -q https://kaiju-idx.s3.eu-central-1.amazonaws.com/2024/kaiju_db_viruses_2024-08-15.tgz -O kaiju_db_viruses.tgz && \
            tar -xzf kaiju_db_viruses.tgz && rm -f kaiju_db_viruses.tgz && \
            subdir=$(find . -maxdepth 1 -type d ! -name . | head -1) && \
            if [ -n "$subdir" ]; then mv "$subdir"/* . 2>/dev/null; rmdir "$subdir" 2>/dev/null || true; fi && \
            for f in kaiju_db_viruses*.fmi kaiju_db_viruses*nodes.dmp kaiju_db_viruses*names.dmp; do \
                [ -f "$f" ] && mv "$f" "$(echo "$f" | sed 's/kaiju_db_viruses[^.]*\./kaiju_db./g; s/kaiju_db_viruses[^_]*_/kaiju_db_/g')"; \
            done 2>/dev/null || true && \
            test -n "$(find . -maxdepth 1 -name '*.fmi' | head -1)" || (echo "Kaiju DB build failed: no .fmi in $KAIJU_DB_DIR" && exit 1)
        cd - >/dev/null
    fi
    
    echo "Setting up CheckV database..."
    CHECKV_DB_DIR="/opt/virall/databases/checkv_db"
    mkdir -p "$CHECKV_DB_DIR"
    if [ ! -f "$CHECKV_DB_DIR/genome_db/checkv_reps.dmnd" ]; then
        if [ ! -f "$CHECKV_DB_DIR/genome_db/checkv_reps.faa" ]; then
            echo "Downloading CheckV database (this may take 10-30 minutes)..."
            cd "$CHECKV_DB_DIR" && \
                curl -fL -o checkv-db.tar.gz https://portal.nersc.gov/CheckV/checkv-db-v1.5.tar.gz && \
                tar -xzf checkv-db.tar.gz --no-same-owner || true && \
                rm -f checkv-db.tar.gz && \
                if [ -d "checkv-db-v1.5" ]; then mv checkv-db-v1.5/* . 2>/dev/null; rm -rf checkv-db-v1.5; fi
            cd - >/dev/null
        fi
        if [ -f "$CHECKV_DB_DIR/genome_db/checkv_reps.faa" ] && [ ! -f "$CHECKV_DB_DIR/genome_db/checkv_reps.dmnd" ]; then
            echo "Building CheckV DIAMOND database from checkv_reps.faa..."
            bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && cd $CHECKV_DB_DIR/genome_db && diamond makedb --in checkv_reps.faa --db checkv_reps"
        fi
        test -f "$CHECKV_DB_DIR/genome_db/checkv_reps.dmnd" || (echo "CheckV DB build failed: genome_db/checkv_reps.dmnd missing" && exit 1)
    fi
    
    echo "Setting up geNomad database (~4GB, for RNA viruses and eukaryotic DNA viruses)..."
    GENOMAD_DB_DIR="/opt/virall/databases/genomad_db"
    mkdir -p "$GENOMAD_DB_DIR"
    if [ ! -d "$GENOMAD_DB_DIR/genomad_db" ] && [ ! -f "$GENOMAD_DB_DIR/virus_hallmark_annotation.txt" ]; then
        echo "Downloading geNomad database (this may take 10-20 minutes)..."
        bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && genomad download-database $GENOMAD_DB_DIR" || echo "Warning: geNomad DB download failed, continuing..."
    fi
    
    echo "Databases installed at:"
    echo "  - VOG: /opt/virall/databases/vog_db"
    echo "  - Kaiju: /opt/virall/databases/kaiju_db"
    echo "  - CheckV: /opt/virall/databases/checkv_db"
    echo "  - geNomad: /opt/virall/databases/genomad_db"

    # Clean up apt cache
    apt-get clean || true
    # Only remove files we can actually remove (skip busy filesystems)
    rm -rf /var/lib/apt/lists/* 2>/dev/null || true
    # Try to clean tmp directories, but ignore errors for busy filesystems
    # IMPORTANT: Don't remove build-temp-* or bundle-temp-* directories - Singularity/Apptainer needs them!
    find /tmp -mindepth 1 -maxdepth 1 ! -name 'build-temp-*' ! -name 'bundle-temp-*' -exec rm -rf {} + 2>/dev/null || true
    find /var/tmp -mindepth 1 -maxdepth 1 -exec rm -rf {} + 2>/dev/null || true

%runscript
    # Activate conda environment
    export PATH=/opt/conda/envs/virall/bin:/opt/conda/bin:$PATH
    export LD_LIBRARY_PATH=/opt/conda/envs/virall/lib:$LD_LIBRARY_PATH
    export CONDA_PREFIX=/opt/conda/envs/virall
    
    echo "Virall Nextflow container is ready!"
    echo ""
    echo "This container is designed for use with the Virall Nextflow pipeline."
    echo "Run with: nextflow run nextflow/main.nf -params-file run_params.yaml -profile singularity"
    echo ""
    echo "Available tools:"
    echo "  - samtools, bwa, minimap2 (mapping)"
    echo "  - spades, flye, medaka (assembly + polishing)"
    echo "  - fastp, fastplong, fastqc (QC)"
    echo "  - checkv, genomad (quality assessment)"
    echo "  - bcftools, pilon, hmmer, prodigal, kaiju"
    echo "  - umi_tools (single-cell sequencing)"
    echo ""
    echo "Databases at /opt/virall/databases/:"
    echo "  - kaiju_db, checkv_db, genomad_db, vog_db"
    exec "$@"

%labels
    Author Virall Team
    Version 0.2.0
    Description Virall - A comprehensive tool for viral genome analysis
    Maintainer bruno.pavletic@gmail.com, britaniadiazf@gmail.com

%help
    Virall Nextflow Container
    =========================
    
    This container includes all bioinformatics tools and databases needed
    for the Virall Nextflow viral genome analysis pipeline.
    
    Installed Tools:
    - Mapping: samtools, bwa, minimap2
    - Assembly: SPAdes, Flye, Medaka (Nanopore polishing)
    - QC: fastp, fastplong, fastqc
    - Quality: checkv (phages), genomad (RNA/eukaryotic viruses)
    - Annotation: prodigal, hmmer (VOG)
    - Classification: kaiju
    - Other: bcftools, pilon
    
    Python Packages (for plotting):
    - numpy, pandas, matplotlib, plotly, biopython
    
    Databases (included at /opt/virall/databases/):
    - VOG: vog_db
    - Kaiju (viruses): kaiju_db
    - CheckV: checkv_db (optimized for phages)
    - geNomad: genomad_db (RNA/eukaryotic viruses)
    
    Quality Assessment Strategy:
    - CheckV is used for bacteriophages (Caudovirales, etc.)
    - geNomad is used for RNA viruses and eukaryotic DNA viruses
    - Results are automatically merged based on Kaiju taxonomy
    
    Usage with Nextflow:
    -------------------
    1. Build container:
       singularity build --fakeroot virall.sif virall.def
    
    2. Run pipeline:
       nextflow run nextflow/main.nf \\
         -params-file nextflow/run_params.yaml \\
         -profile singularity
    
    Note: The virall Python package is NOT installed in this container.
    All plotting and analysis logic is self-contained in nextflow/bin/run_plots.py

