Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C
    export PATH=/opt/miniconda3/bin:$PATH
    export CONDA_PREFIX=/opt/miniconda3/envs/virall
    export PATH=/opt/miniconda3/envs/virall/bin:$PATH
    export LD_LIBRARY_PATH=/opt/miniconda3/envs/virall/lib:$LD_LIBRARY_PATH
    
    # Virall paths
    export VIRALL_HOME=/opt/virall
    export VOG_DB_DIR=/opt/virall/databases/vog_db
    export KAIJU_DB_DIR=/opt/virall/databases/kaiju_db
    export CHECKV_DB_DIR=/opt/virall/databases/checkv_db

%post
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C
    
    # Install system dependencies
    apt-get update && apt-get install -y \
        build-essential \
        wget \
        curl \
        bzip2 \
        ca-certificates \
        libglib2.0-0 \
        libxext6 \
        libsm6 \
        libxrender1 \
        git \
        libcrypt1 \
        && rm -rf /var/lib/apt/lists/*
    
    # Install Miniconda
    cd /tmp
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda3
    rm Miniconda3-latest-Linux-x86_64.sh
    
    # Initialize conda
    /opt/miniconda3/bin/conda init bash
    export PATH=/opt/miniconda3/bin:$PATH
    
    # Accept conda Terms of Service
    conda config --set auto_activate_base false
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main || true
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r || true
    
    # Create conda environment
    conda create -n virall -y python=3.11
    
    # Activate environment and install mamba
    source /opt/miniconda3/etc/profile.d/conda.sh
    conda activate virall
    conda install -c conda-forge mamba -y
    
    # Install Python dependencies with conda
    conda install -c conda-forge -y \
        numpy \
        pandas \
        matplotlib \
        seaborn \
        plotly \
        biopython \
        scikit-learn \
        click \
        tqdm \
        pyyaml \
        loguru \
        psutil
    
    # Install bioinformatics tools using mamba
    # Mapping/alignment tools
    mamba install -c bioconda -c conda-forge -y \
        samtools \
        bwa \
        minimap2
    
    # Assembly tools
    mamba install -c conda-forge -c bioconda -y \
        spades=4.2.0 \
        flye=2.9.6
    
    # QC tools
    mamba install -c bioconda -c conda-forge -y \
        fastp \
        fastplong=0.4.1 \
        fastqc
    
    # Other tools
    mamba install -c bioconda -y \
        checkv \
        bcftools \
        pilon \
        hmmer \
        prodigal \
        kaiju
    
    # Fix SPAdes PATH issue (create symlink)
    SPADES_PATH=$(find $CONDA_PREFIX -name "spades.py" 2>/dev/null | head -1)
    if [ -n "$SPADES_PATH" ]; then
        ln -sf "$SPADES_PATH" "$CONDA_PREFIX/bin/spades"
    fi
    
    # Ensure OpenMPI libraries are accessible (SPAdes dependency)
    if [ -d "$CONDA_PREFIX/lib" ]; then
        # Find and link OpenMPI libraries
        OPENMPI_LIB=$(find $CONDA_PREFIX -type f -name "libmpi.so.40*" 2>/dev/null | grep -E "libmpi\.so\.40$|libmpi\.so\.40\." | head -1)
        if [ -n "$OPENMPI_LIB" ]; then
            OPENMPI_LIB_DIR=$(dirname "$OPENMPI_LIB")
            mkdir -p "$CONDA_PREFIX/lib"
            for lib in "$OPENMPI_LIB_DIR"/*.so*; do
                if [ -f "$lib" ] || [ -L "$lib" ]; then
                    lib_name=$(basename "$lib")
                    ln -sf "$lib" "$CONDA_PREFIX/lib/$lib_name" 2>/dev/null || true
                fi
            done
        fi
        export LD_LIBRARY_PATH="$CONDA_PREFIX/lib:$LD_LIBRARY_PATH"
    fi
    
    # Create virall directory structure
    mkdir -p /opt/virall
    mkdir -p /opt/virall/databases/vog_db
    mkdir -p /opt/virall/databases/kaiju_db
    mkdir -p /opt/virall/databases/checkv_db
    
    # Clean up conda cache to reduce image size
    conda clean -afy
    mamba clean -afy
    
    # Clean up temporary files
    rm -rf /tmp/*

%files
    # Copy virall source code
    virall /opt/virall/virall
    setup.py /opt/virall/setup.py
    requirements.txt /opt/virall/requirements.txt
    configs /opt/virall/configs
    README.md /opt/virall/README.md
    LICENSE /opt/virall/LICENSE

%post
    # Install virall package in development mode
    cd /opt/virall
    source /opt/miniconda3/etc/profile.d/conda.sh
    conda activate virall
    pip install -e .
    
    # Set up VOG database (after virall is installed)
    echo "Setting up VOG database..."
    export LD_LIBRARY_PATH="$CONDA_PREFIX/lib:$LD_LIBRARY_PATH"
    python -c "
import os
import sys
from virall.core.vog_annotator import VOGAnnotator

# Set LD_LIBRARY_PATH for subprocess calls
conda_prefix = os.environ.get('CONDA_PREFIX', '')
if conda_prefix:
    lib_path = os.path.join(conda_prefix, 'lib')
    if os.path.isdir(lib_path):
        current_ld_path = os.environ.get('LD_LIBRARY_PATH', '')
        new_ld_path = f'{lib_path}:{current_ld_path}' if current_ld_path else lib_path
        os.environ['LD_LIBRARY_PATH'] = new_ld_path

try:
    annotator = VOGAnnotator()
    if annotator.setup_vog_database('/opt/virall/databases/vog_db'):
        print('VOG database setup completed successfully')
        sys.exit(0)
    else:
        print('VOG database setup failed')
        sys.exit(1)
except Exception as e:
    print(f'VOG database setup error: {e}')
    sys.exit(1)
" || echo "Warning: VOG database setup failed, can be set up later"
    
    # Set up Kaiju database
    echo "Setting up Kaiju database..."
    if command -v kaiju-makedb >/dev/null 2>&1; then
        kaiju-makedb -s viruses -d /opt/virall/databases/kaiju_db || echo "Warning: Kaiju database setup failed, can be set up later"
        
        # Clean up temporary files
        cd /opt/virall/databases/kaiju_db
        rm -f kaiju_db_viruses.bwt kaiju_db_viruses.sa 2>/dev/null || true
        
        # Download taxonomy files if needed
        if [ ! -f "/opt/virall/databases/kaiju_db/nodes.dmp" ]; then
            cd /opt/virall/databases/kaiju_db
            curl -L -o taxdump.tar.gz https://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz || echo "Warning: Taxonomy download failed"
            if [ -f taxdump.tar.gz ]; then
                tar -xzf taxdump.tar.gz && rm -f taxdump.tar.gz
            fi
        fi
    else
        echo "Warning: kaiju-makedb not found, skipping Kaiju database setup"
    fi
    
    # Set up CheckV database
    echo "Setting up CheckV database..."
    if command -v checkv >/dev/null 2>&1; then
        checkv download_database /opt/virall/databases/checkv_db || {
            echo "Warning: CheckV database download failed, trying manual download..."
            cd /opt/virall/databases/checkv_db
            curl -fL -o checkv-db.tar.gz https://portal.nersc.gov/CheckV/checkv-db-v1.5.tar.gz || echo "Warning: Manual CheckV download failed"
            if [ -f checkv-db.tar.gz ]; then
                tar -xzf checkv-db.tar.gz && rm -f checkv-db.tar.gz
            fi
        }
    else
        echo "Warning: checkv not found, skipping CheckV database setup"
    fi

%runscript
    # Default command: run virall
    exec /opt/miniconda3/envs/virall/bin/virall "$@"

%labels
    Author "Virall Team"
    Version "0.1.0"
    Description "Virall - A comprehensive tool for viral genome analysis including assembly, classification, gene prediction, and annotation"
    Maintainer "bruno.pavletic@gmail.com, britaniadiazf@gmail.com"

%help
    Virall Container - Viral Genome Assembly and Analysis
    
    This container includes:
    - All bioinformatics tools (SPAdes, Flye, BWA, minimap2, etc.)
    - Python dependencies (numpy, pandas, biopython, etc.)
    - Pre-installed databases (VOG, Kaiju, CheckV)
    - Virall package ready to use
    
    Usage:
        singularity run virall.sif --help
        singularity exec virall.sif virall --input reads.fastq --output results/
        singularity shell virall.sif
    
    Database locations:
        VOG: /opt/virall/databases/vog_db
        Kaiju: /opt/virall/databases/kaiju_db
        CheckV: /opt/virall/databases/checkv_db

