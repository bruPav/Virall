Bootstrap: docker
From: continuumio/miniconda3:py311

%labels
    Author: Virall Team
    Version: 1.0
    Description: Virall - Viral Assembly Pipeline (with databases included)
    Date: 2024

%environment
    # Set PATH
    export PATH=/opt/conda/bin:$PATH
    # Include both conda lib and system lib (for OpenMPI)
    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    
    # Database paths (set via environment variable or bind mount)
    # Default locations (can be overridden)
    export VOG_DB_DIR=${VOG_DB_DIR:-/opt/virall/databases/vog_db}
    export KAIJU_DB_DIR=${KAIJU_DB_DIR:-/opt/virall/databases/kaiju_db}
    export CHECKV_DB_DIR=${CHECKV_DB_DIR:-/opt/virall/databases/checkv_db}
    
    # Python path
    export PYTHONPATH=/opt/virall:$PYTHONPATH

%files
    # Copy virall package files
    ./virall /opt/virall/virall/
    ./setup.py /opt/virall/setup.py
    ./requirements.txt /opt/virall/requirements.txt
    ./configs /opt/virall/configs/
    ./README.md /opt/virall/README.md
    ./LICENSE /opt/virall/LICENSE

%post
    # Update system packages (install OpenMPI AFTER conda/Python to avoid conflicts)
    apt-get update && apt-get install -y \
        build-essential \
        gcc \
        g++ \
        make \
        curl \
        wget \
        tar \
        gzip \
        bzip2 \
        ca-certificates \
        && rm -rf /var/lib/apt/lists/*

    # Initialize conda first (before installing OpenMPI to avoid library conflicts)
    export PATH=/opt/conda/bin:$PATH
    # Prioritize conda libraries over system libraries to avoid conflicts
    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    
    # Use only conda-forge and bioconda to avoid ToS issues
    conda config --remove channels defaults 2>/dev/null || true
    conda config --add channels conda-forge
    conda config --add channels bioconda
    conda config --set channel_priority flexible
    conda config --set auto_activate_base false

    # Install mamba for faster package management
    echo "Installing mamba..."
    conda install -c conda-forge mamba -y
    
    # Install expat from conda-forge to avoid conflicts
    echo "Installing expat library..."
    conda install -c conda-forge expat -y

    # Install Python dependencies
    echo "Installing Python dependencies..."
    conda install -c conda-forge -y \
        numpy pandas matplotlib seaborn plotly \
        biopython scikit-learn click tqdm pyyaml loguru psutil

    # Install bioinformatics tools
    echo "Installing bioinformatics tools..."
    
    # Mapping tools
    mamba install -c bioconda -c conda-forge -y \
        samtools bwa minimap2

    # Assembly tools
    mamba install -c bioconda -c conda-forge -y \
        spades=4.2.0 flye=2.9.6

    # QC tools (install individually to handle dependencies better)
    mamba install -c bioconda -c conda-forge fastp -y || true
    mamba install -c bioconda -c conda-forge fastplong -y || mamba install -c bioconda fastplong -y || true
    mamba install -c bioconda -c conda-forge fastqc -y || true

    # Install OpenMPI from system packages AFTER conda is set up
    # This avoids library conflicts with Python/expat
    echo "Installing OpenMPI from system packages (needed for HMMER)..."
    apt-get update && apt-get install -y \
        libopenmpi-dev \
        openmpi-bin \
        openmpi-common \
        && rm -rf /var/lib/apt/lists/*
    
    # Note: OpenMPI libraries will be found via LD_LIBRARY_PATH
    # which already includes /usr/lib/x86_64-linux-gnu
    echo "OpenMPI installed - libraries accessible via LD_LIBRARY_PATH"

    # Other tools (HMMER needs OpenMPI from system packages, now installed above)
    mamba install -c bioconda -y \
        checkv bcftools pilon hmmer prodigal kaiju

    # Fix SPAdes PATH issue
    echo "Creating SPAdes symlink..."
    SPADES_PATH=$(find /opt/conda -name "spades.py" 2>/dev/null | head -1)
    if [ -n "$SPADES_PATH" ]; then
        ln -sf "$SPADES_PATH" /opt/conda/bin/spades
    fi

    # Ensure OpenMPI libraries are accessible (for SPAdes)
    echo "Setting up OpenMPI libraries..."
    if [ -d /opt/conda/lib ]; then
        export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH
        # Find and link OpenMPI libraries if needed
        OPENMPI_LIB=$(find /opt/conda -name "libmpi.so.40*" 2>/dev/null | head -1)
        if [ -n "$OPENMPI_LIB" ]; then
            OPENMPI_LIB_DIR=$(dirname "$OPENMPI_LIB")
            for lib in "$OPENMPI_LIB_DIR"/*.so*; do
                if [ -f "$lib" ] || [ -L "$lib" ]; then
                    lib_name=$(basename "$lib")
                    ln -sf "$lib" /opt/conda/lib/"$lib_name" 2>/dev/null || true
                fi
            done
        fi
    fi

    # Upgrade pip and ensure expat compatibility
    echo "Upgrading pip..."
    pip install --upgrade pip
    
    # Install virall package
    echo "Installing virall package..."
    cd /opt/virall
    pip install -e .

    # Set up databases inside the container
    echo "Setting up databases inside container..."
    mkdir -p /opt/virall/databases/vog_db
    mkdir -p /opt/virall/databases/kaiju_db
    mkdir -p /opt/virall/databases/checkv_db
    
    # Set up VOG database
    echo "Setting up VOG database (~1GB)..."
    export VOG_DB_DIR=/opt/virall/databases/vog_db
    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    python -c "
import os
import sys
from virall.core.vog_annotator import VOGAnnotator

os.environ['LD_LIBRARY_PATH'] = '/opt/conda/lib:/usr/lib/x86_64-linux-gnu:' + os.environ.get('LD_LIBRARY_PATH', '')

try:
    annotator = VOGAnnotator()
    if annotator.setup_vog_database('/opt/virall/databases/vog_db'):
        print('VOG database setup completed successfully')
        sys.exit(0)
    else:
        print('VOG database setup failed')
        sys.exit(1)
except Exception as e:
    print(f'VOG database setup error: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
" || {
        echo "Warning: VOG database setup failed, trying manual pressing..."
        if [ -f /opt/virall/databases/vog_db/vog.hmm ] && [ ! -f /opt/virall/databases/vog_db/vog.hmm.h3m ]; then
            cd /opt/virall/databases/vog_db
            LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH hmmpress vog.hmm || \
            LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH hmmpress vog.hmm || true
        fi
    }
    
    # Set up Kaiju database
    echo "Setting up Kaiju database (~1GB)..."
    export KAIJU_DB_DIR=/opt/virall/databases/kaiju_db
    cd /opt/virall/databases/kaiju_db
    kaiju-makedb -s viruses -d /opt/virall/databases/kaiju_db || {
        echo "Warning: Kaiju database setup failed, trying alternative..."
        kaiju-makedb -s viruses -d /opt/virall/databases/kaiju_db --force || true
    }
    # Clean up temporary files
    rm -f /opt/virall/databases/kaiju_db/kaiju_db_viruses.bwt /opt/virall/databases/kaiju_db/kaiju_db_viruses.sa 2>/dev/null || true
    # Verify nodes.dmp exists
    if [ ! -f /opt/virall/databases/kaiju_db/nodes.dmp ]; then
        echo "Downloading Kaiju taxonomy files..."
        kaiju-makedb -d /opt/virall/databases/kaiju_db || {
            echo "Trying manual download of taxonomy files..."
            cd /opt/virall/databases/kaiju_db
            curl -L -o taxdump.tar.gz https://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz || \
            wget -O taxdump.tar.gz https://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz || true
            if [ -f taxdump.tar.gz ]; then
                tar -xzf taxdump.tar.gz
                rm -f taxdump.tar.gz
            fi
        }
    fi
    
    # Set up CheckV database
    echo "Setting up CheckV database (~3GB)..."
    export CHECKV_DB_DIR=/opt/virall/databases/checkv_db
    checkv download_database /opt/virall/databases/checkv_db || {
        echo "Warning: CheckV database setup failed, trying alternative..."
        checkv download_database /opt/virall/databases/checkv_db --force || {
            echo "Trying manual download of CheckV database..."
            cd /opt/virall/databases/checkv_db
            CHECKV_URL="https://portal.nersc.gov/CheckV/checkv-db-v1.5.tar.gz"
            curl -L -o checkv-db.tar.gz "$CHECKV_URL" || \
            wget -O checkv-db.tar.gz "$CHECKV_URL" || true
            if [ -f checkv-db.tar.gz ]; then
                tar -xzf checkv-db.tar.gz
                rm -f checkv-db.tar.gz
            fi
        }
    }
    
    echo "Database setup completed!"

    # Verify critical tools
    echo "Verifying installation..."
    samtools --version >/dev/null 2>&1 || echo "Warning: samtools not working"
    bwa >/dev/null 2>&1 || echo "Warning: bwa not working"
    minimap2 --version >/dev/null 2>&1 || echo "Warning: minimap2 not working"

    # Clean up conda cache to reduce image size
    echo "Cleaning up conda cache..."
    conda clean -afy
    mamba clean -afy

    # Test virall import
    python -c "from virall import ViralAssembler; print('Virall installation verified')" || \
        echo "Warning: Virall import test failed"

    echo "Container build completed with databases!"

%runscript
    # Default command - pass arguments to virall
    exec virall "$@"

%help
    Virall - Viral Assembly Pipeline Container (WITH databases included)
    
    This container includes:
    - All bioinformatics tools (SPAdes, Flye, BWA, samtools, etc.)
    - All Python dependencies
    - All databases (VOG, Kaiju, CheckV)
    - Total size: ~8-10GB (with databases)
    
    Usage:
        # Basic usage (databases are already included)
        singularity run virall.sif analyse --short-reads-1 reads.fq -o output/
        
        # Override database location if needed
        singularity run \
            --env VOG_DB_DIR=/path/to/vog_db \
            --env KAIJU_DB_DIR=/path/to/kaiju_db \
            --env CHECKV_DB_DIR=/path/to/checkv_db \
            virall.sif analyse --short-reads-1 reads.fq -o output/
    
    For more information, see: https://github.com/bruPav/virall

