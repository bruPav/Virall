Bootstrap: docker
From: ubuntu:22.04

%files
    # Copy virall source code into container
    # Paths are relative to where you run: singularity build virall.sif virall.def
    # Run from the virall source directory (where setup.py is located)
    virall /opt/virall/src/virall
    setup.py /opt/virall/src/setup.py
    requirements.txt /opt/virall/src/requirements.txt
    README.md /opt/virall/src/README.md
    configs /opt/virall/src/configs
    LICENSE /opt/virall/src/LICENSE

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/bin:/opt/conda/envs/virall/bin:$PATH
    export CONDA_PREFIX=/opt/conda/envs/virall
    export LD_LIBRARY_PATH=/opt/conda/envs/virall/lib:$LD_LIBRARY_PATH
    export LC_ALL=C
    export LANG=C.UTF-8

%post
    # Set environment variables
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/bin:$PATH
    export LC_ALL=C
    export LANG=C.UTF-8

    # Check initial disk space
    echo "=== Initial disk space check ==="
    df -h

    # Update system and install basic dependencies
    apt-get update && apt-get install -y \
        wget \
        curl \
        bzip2 \
        ca-certificates \
        libcrypt1 \
        build-essential \
        gcc \
        g++ \
        make \
        git \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    cd /tmp
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh

    # Initialize conda
    /opt/conda/bin/conda init bash
    /opt/conda/bin/conda config --set auto_update_conda false
    /opt/conda/bin/conda config --set channel_priority flexible

    # Accept conda Terms of Service
    /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main || true
    /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r || true

    # Create conda environment with Python 3.11
    /opt/conda/bin/conda create -n virall -y python=3.11

    # Set up conda environment variables
    export CONDA_PREFIX=/opt/conda/envs/virall
    export PATH=/opt/conda/bin:$CONDA_PREFIX/bin:$PATH

    # Use bash to activate conda environment and install packages
    # Install Python dependencies with conda
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c conda-forge -y \
        numpy \
        pandas \
        matplotlib \
        seaborn \
        plotly \
        biopython \
        scikit-learn \
        click \
        tqdm \
        pyyaml \
        loguru \
        psutil"

    # Install mamba for faster dependency solving
    echo "=== Checking disk space before installing mamba ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi
    
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c conda-forge mamba -y"
    
    echo "=== Checking disk space after installing mamba ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Install bioinformatics tools using mamba
    # Install tools individually and clean cache frequently to avoid running out of space
    # This approach is more resilient to network issues and package extraction failures
    
    # Mapping/alignment tools - install individually
    echo "Installing samtools..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y samtools" || echo "Warning: samtools installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing bwa..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y bwa" || echo "Warning: bwa installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing minimap2..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y minimap2" || echo "Warning: minimap2 installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after mapping tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Assembly tools - install individually (these are large packages)
    echo "Installing SPAdes..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c conda-forge -c bioconda -y spades=4.2.0" || echo "Warning: SPAdes installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing Flye..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c conda-forge -c bioconda -y flye=2.9.6" || echo "Warning: Flye installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after assembly tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # QC tools - install individually
    # Use conda for fastp to avoid mamba hangs (mamba has GLIBCXX compatibility issues after libstdcxx upgrade)
    echo "Installing fastp..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastp" || echo "Warning: fastp installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    # Use conda for fastplong to avoid mamba segmentation faults (mamba crashes after libstdcxx upgrade)
    echo "Installing fastplong..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastplong=0.4.1" || echo "Warning: fastplong installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing fastqc..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && mamba install -c bioconda -c conda-forge -y fastqc" || echo "Warning: fastqc installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after QC tools ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Other bioinformatics tools - install individually using conda instead of mamba
    # (mamba has GLIBCXX compatibility issues after libstdcxx upgrade)
    echo "Installing bcftools..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y bcftools" || echo "Warning: bcftools installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing hmmer..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y hmmer" || echo "Warning: hmmer installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing prodigal..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y prodigal" || echo "Warning: prodigal installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing pilon..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y pilon" || echo "Warning: pilon installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing checkv..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y checkv" || echo "Warning: checkv installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Installing kaiju..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -y kaiju" || echo "Warning: kaiju installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    # Try to install minimap2 and fastqc with conda (they failed with mamba)
    echo "Retrying minimap2 with conda..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y minimap2" || echo "Warning: minimap2 installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "Retrying fastqc with conda..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda install -c bioconda -c conda-forge -y fastqc" || echo "Warning: fastqc installation failed, continuing..."
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Checking disk space after all tool installations ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Fix OpenMPI libraries for SPAdes (needed for HMMER)
    if [ -d "$CONDA_PREFIX/lib" ]; then
        # Find OpenMPI libraries installed with SPAdes
        OPENMPI_LIB=$(find $CONDA_PREFIX -type f -name "libmpi.so.40*" 2>/dev/null | grep -E "libmpi\.so\.40$|libmpi\.so\.40\." | head -1)
        
        if [ -n "$OPENMPI_LIB" ]; then
            OPENMPI_LIB_DIR=$(dirname "$OPENMPI_LIB")
            # Link all OpenMPI libraries to environment lib directory
            mkdir -p "$CONDA_PREFIX/lib"
            for lib in "$OPENMPI_LIB_DIR"/*.so*; do
                if [ -f "$lib" ] || [ -L "$lib" ]; then
                    lib_name=$(basename "$lib")
                    ln -sf "$lib" "$CONDA_PREFIX/lib/$lib_name" 2>/dev/null || true
                fi
            done
        fi
    fi

    # Create SPAdes symlink
    SPADES_PATH=$(find $CONDA_PREFIX -name "spades.py" 2>/dev/null | head -1)
    if [ -n "$SPADES_PATH" ]; then
        ln -sf "$SPADES_PATH" "$CONDA_PREFIX/bin/spades"
    fi

    # Create directories for databases (to be populated at runtime or via bind mounts)
    mkdir -p /opt/virall/databases/vog_db
    mkdir -p /opt/virall/databases/kaiju_db
    mkdir -p /opt/virall/databases/checkv_db
    
    # Create directory for virall source code
    # The source code should be copied into the container during build
    # using: singularity build --fakeroot virall.sif virall.def
    # with the source code in the same directory as the .def file
    mkdir -p /opt/virall/src

    # Final cleanup of conda cache (already cleaned after each tool, but do one more pass)
    bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && conda clean -afy" || true
    
    echo "=== Final disk space check after cleanup ==="
    df -h
    if [ -d "/opt/conda/pkgs" ]; then
        echo "Conda cache size:"
        du -sh /opt/conda/pkgs 2>/dev/null || true
    fi

    # Install virall package (if source code is available)
    # This assumes the virall source code is in the build context
    # Copy source code if it exists in the build directory
    if [ -d "/opt/virall/src" ] && [ -f "/opt/virall/src/setup.py" ]; then
        cd /opt/virall/src
        bash -c ". /opt/conda/etc/profile.d/conda.sh && conda activate virall && pip install -e ."
    else
        echo "Note: Virall source code not found during build."
        echo "Install it at runtime with: pip install -e /path/to/virall/source"
    fi

    # Clean up apt cache
    apt-get clean || true
    # Only remove files we can actually remove (skip busy filesystems)
    rm -rf /var/lib/apt/lists/* 2>/dev/null || true
    # Try to clean tmp directories, but ignore errors for busy filesystems
    # IMPORTANT: Don't remove build-temp-* or bundle-temp-* directories - Singularity/Apptainer needs them!
    find /tmp -mindepth 1 -maxdepth 1 ! -name 'build-temp-*' ! -name 'bundle-temp-*' -exec rm -rf {} + 2>/dev/null || true
    find /var/tmp -mindepth 1 -maxdepth 1 -exec rm -rf {} + 2>/dev/null || true

%runscript
    # Activate conda environment and run virall
    # Runscript uses bash by default, so source works here
    export PATH=/opt/conda/bin:/opt/conda/envs/virall/bin:$PATH
    export LD_LIBRARY_PATH=/opt/conda/envs/virall/lib:$LD_LIBRARY_PATH
    export CONDA_PREFIX=/opt/conda/envs/virall
    
    # If virall is installed, run it; otherwise show help
    if command -v virall >/dev/null 2>&1; then
        exec virall "$@"
    else
        echo "Virall container is ready!"
        echo "To install virall package, mount the source code and run:"
        echo "  /opt/conda/bin/conda run -n virall pip install -e /path/to/virall/source"
        echo ""
        echo "Available tools:"
        echo "  - samtools, bwa, minimap2 (mapping)"
        echo "  - spades, flye (assembly)"
        echo "  - fastp, fastplong, fastqc (QC)"
        echo "  - checkv, bcftools, pilon, hmmer, prodigal, kaiju"
        exec "$@"
    fi

%labels
    Author Virall Team
    Version 0.1.0
    Description Virall - A comprehensive tool for viral genome analysis
    Maintainer bruno.pavletic@gmail.com, britaniadiazf@gmail.com

%help
    Virall Singularity Container
    ============================
    
    This container includes all bioinformatics tools and dependencies needed
    for the Virall viral genome analysis pipeline.
    
    Installed Tools:
    - Mapping: samtools, bwa, minimap2
    - Assembly: SPAdes 4.2.0, Flye 2.9.6
    - QC: fastp, fastplong 0.4.1, fastqc
    - Other: checkv, bcftools, pilon, hmmer, prodigal, kaiju
    
    Python Packages:
    - numpy, pandas, matplotlib, seaborn, plotly
    - biopython, scikit-learn, click, tqdm, pyyaml, loguru, psutil
    
    Usage:
    ------
    1. Build the container (from the virall source directory):
       # Option A: Build with source code included (recommended)
       # First, edit the %files section in virall.def to include source files
       singularity build --fakeroot virall.sif virall.def
       
       # Option B: Build without source, install at runtime
       singularity build virall.sif virall.def
       # Then install virall package:
       singularity exec virall.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate virall && pip install -e /path/to/virall/source"
    
    2. Set up databases (at runtime or via bind mounts):
       - VOG database: /opt/virall/databases/vog_db
       - Kaiju database: /opt/virall/databases/kaiju_db
       - CheckV database: /opt/virall/databases/checkv_db
       
       # Mount existing databases from host:
       singularity exec -B /path/to/host/databases:/opt/virall/databases virall.sif virall ...
       
       # Or download databases inside container:
       singularity exec virall.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate virall && python -c 'from virall.core.vog_annotator import VOGAnnotator; VOGAnnotator().setup_vog_database(\"/opt/virall/databases/vog_db\")'"
    
    3. Run virall:
       singularity exec virall.sif virall --help
       # Or with database bind mount:
       singularity exec -B /path/to/databases:/opt/virall/databases virall.sif virall --help
    
    Note: Databases are not included in the container image due to size (~4GB total).
    They should be downloaded at runtime or mounted from the host system.
    
    To include source code during build, uncomment and adjust paths in the %files section.

