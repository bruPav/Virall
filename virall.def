Bootstrap: docker
From: continuumio/miniconda3:latest

%labels
    Author: Virall Team
    Version: 1.0
    Description: Virall - Viral Assembly Pipeline (without databases - databases installed separately)
    Date: 2024

%environment
    # Set PATH
    export PATH=/opt/conda/bin:$PATH
    # Include both conda lib and system lib (for OpenMPI)
    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    
    # Database paths (set via environment variable or bind mount)
    # Default locations (can be overridden)
    export VOG_DB_DIR=${VOG_DB_DIR:-/opt/virall/databases/vog_db}
    export KAIJU_DB_DIR=${KAIJU_DB_DIR:-/opt/virall/databases/kaiju_db}
    export CHECKV_DB_DIR=${CHECKV_DB_DIR:-/opt/virall/databases/checkv_db}
    
    # Python path
    export PYTHONPATH=/opt/virall:$PYTHONPATH

%files
    # Copy virall package files
    ./virall /opt/virall/virall/
    ./setup.py /opt/virall/setup.py
    ./requirements.txt /opt/virall/requirements.txt
    ./configs /opt/virall/configs/
    ./README.md /opt/virall/README.md
    ./LICENSE /opt/virall/LICENSE

%post
    # Update system packages
    apt-get update && apt-get install -y \
        build-essential \
        gcc \
        g++ \
        make \
        curl \
        wget \
        tar \
        gzip \
        bzip2 \
        ca-certificates \
        libopenmpi-dev \
        openmpi-bin \
        openmpi-common \
        && rm -rf /var/lib/apt/lists/*
    
    # Link OpenMPI libraries to conda lib directory so HMMER can find them
    echo "Linking OpenMPI libraries for HMMER..."
    mkdir -p /opt/conda/lib
    # Find OpenMPI libraries (usually in /usr/lib/x86_64-linux-gnu/)
    if [ -d /usr/lib/x86_64-linux-gnu ]; then
        for lib in /usr/lib/x86_64-linux-gnu/libmpi.so*; do
            if [ -f "$lib" ] || [ -L "$lib" ]; then
                lib_name=$(basename "$lib")
                ln -sf "$lib" /opt/conda/lib/"$lib_name" 2>/dev/null || true
            fi
        done
    fi
    # Also check /usr/lib
    if [ -d /usr/lib ]; then
        for lib in /usr/lib/libmpi.so*; do
            if [ -f "$lib" ] || [ -L "$lib" ]; then
                lib_name=$(basename "$lib")
                ln -sf "$lib" /opt/conda/lib/"$lib_name" 2>/dev/null || true
            fi
        done
    fi

    # Initialize conda
    export PATH=/opt/conda/bin:$PATH
    # Prioritize conda libraries over system libraries to avoid conflicts
    export LD_LIBRARY_PATH=/opt/conda/lib:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
    conda config --add channels conda-forge
    conda config --add channels bioconda
    conda config --set channel_priority flexible

    # Accept conda Terms of Service
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main 2>/dev/null || true
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r 2>/dev/null || true

    # Install mamba for faster package management
    echo "Installing mamba..."
    conda install -c conda-forge mamba -y
    
    # Install expat early to fix Python/pip compatibility issues
    echo "Installing expat library..."
    conda install -c conda-forge expat -y

    # Install Python dependencies
    echo "Installing Python dependencies..."
    conda install -c conda-forge -y \
        python=3.11 \
        numpy pandas matplotlib seaborn plotly \
        biopython scikit-learn click tqdm pyyaml loguru psutil

    # Install bioinformatics tools
    echo "Installing bioinformatics tools..."
    
    # Mapping tools
    mamba install -c bioconda -c conda-forge -y \
        samtools bwa minimap2

    # Assembly tools
    mamba install -c bioconda -c conda-forge -y \
        spades=4.2.0 flye=2.9.6

    # QC tools (install individually to handle dependencies better)
    mamba install -c bioconda -c conda-forge fastp -y || true
    mamba install -c bioconda -c conda-forge fastplong -y || mamba install -c bioconda fastplong -y || true
    mamba install -c bioconda -c conda-forge fastqc -y || true

    # Other tools (HMMER needs OpenMPI from system packages, already installed above)
    mamba install -c bioconda -y \
        checkv bcftools pilon hmmer prodigal kaiju

    # Fix SPAdes PATH issue
    echo "Creating SPAdes symlink..."
    SPADES_PATH=$(find /opt/conda -name "spades.py" 2>/dev/null | head -1)
    if [ -n "$SPADES_PATH" ]; then
        ln -sf "$SPADES_PATH" /opt/conda/bin/spades
    fi

    # Ensure OpenMPI libraries are accessible (for SPAdes)
    echo "Setting up OpenMPI libraries..."
    if [ -d /opt/conda/lib ]; then
        export LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH
        # Find and link OpenMPI libraries if needed
        OPENMPI_LIB=$(find /opt/conda -name "libmpi.so.40*" 2>/dev/null | head -1)
        if [ -n "$OPENMPI_LIB" ]; then
            OPENMPI_LIB_DIR=$(dirname "$OPENMPI_LIB")
            for lib in "$OPENMPI_LIB_DIR"/*.so*; do
                if [ -f "$lib" ] || [ -L "$lib" ]; then
                    lib_name=$(basename "$lib")
                    ln -sf "$lib" /opt/conda/lib/"$lib_name" 2>/dev/null || true
                fi
            done
        fi
    fi

    # Upgrade pip and ensure expat compatibility
    echo "Upgrading pip..."
    pip install --upgrade pip
    
    # Install virall package
    echo "Installing virall package..."
    cd /opt/virall
    pip install -e .

    # Create database directories (but don't download databases)
    echo "Creating database directories (databases will be installed separately)..."
    mkdir -p /opt/virall/databases/vog_db
    mkdir -p /opt/virall/databases/kaiju_db
    mkdir -p /opt/virall/databases/checkv_db

    # Note: Databases are NOT downloaded during build
    # They should be downloaded separately using the setup_databases.sh script

    # Verify critical tools
    echo "Verifying installation..."
    samtools --version >/dev/null 2>&1 || echo "Warning: samtools not working"
    bwa >/dev/null 2>&1 || echo "Warning: bwa not working"
    minimap2 --version >/dev/null 2>&1 || echo "Warning: minimap2 not working"

    # Clean up conda cache to reduce image size
    echo "Cleaning up conda cache..."
    conda clean -afy
    mamba clean -afy

    # Test virall import
    python -c "from virall import ViralAssembler; print('Virall installation verified')" || \
        echo "Warning: Virall import test failed"

    echo "Container build completed (without databases)!"

%runscript
    # Default command - pass arguments to virall
    exec virall "$@"

%help
    Virall - Viral Assembly Pipeline Container (WITHOUT databases)
    
    This container includes:
    - All bioinformatics tools (SPAdes, Flye, BWA, samtools, etc.)
    - All Python dependencies
    - Total size: ~2-3GB (without databases)
    
    Databases are NOT included. They must be installed separately using:
    - setup_databases.sh script
    - Or bind mount from host
    
    Usage:
        # Basic usage (databases must be set up separately)
        singularity run virall.sif analyse --short-reads-1 reads.fq -o output/
        
        # With bind mounts for databases
        singularity run \
            --bind /path/to/databases:/opt/virall/databases \
            virall.sif analyse --short-reads-1 reads.fq -o output/
    
    For more information, see: https://github.com/bruPav/virall

