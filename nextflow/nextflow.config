/*
 * Virall Nextflow configuration (tools-direct pipeline).
 * Set database paths or VIRALL_DATABASE_DIR for Kaiju/CheckV/VOG.
 */

params {
    samples           = "nextflow/samples.csv"
    outdir            = "results"
    threads           = 8
    memory            = "16G"
    reference         = null
    rna_mode          = false
    assembly_strategy = "hybrid"
    min_contig_len    = 1000
    quality_phred     = 20
    min_read_len      = 50
    min_read_len_long = 1000
    kaiju_db          = null
    checkv_db         = null
    vog_db            = null
}

process {
    maxRetries   = 1
    errorStrategy = 'retry'
    withName: PREPROCESS {
        time = '2 h'
        memory = '8 GB'
        cpus = params.threads
    }
    withName: HOST_FILTER {
        time = '4 h'
        memory = '16 GB'
        cpus = params.threads
    }
    withName: ASSEMBLE {
        time = '24 h'
        memory = 24.GB   // fixed so retries don't double; fits ~31 GB usable RAM
        cpus = params.threads
    }
    withName: KAIJU {
        time = '4 h'
        memory = '16 GB'
        cpus = params.threads
    }
    withName: FILTER_VIRAL {
        time = '1 h'
        memory = '4 GB'
        cpus = 1
    }
    withName: VALIDATE {
        time = '2 h'
        memory = '8 GB'
        cpus = params.threads
    }
    withName: GENOMAD {
        time = '4 h'
        memory = '16 GB'
        cpus = params.threads
    }
    withName: MERGE_QUALITY {
        time = '1 h'
        memory = '4 GB'
        cpus = 1
    }
    withName: ANNOTATE {
        time = '2 h'
        memory = '8 GB'
        cpus = params.threads
    }
    withName: ORGANIZE_GENES {
        time = '1 h'
        memory = '4 GB'
        cpus = 1
    }
    withName: QUANTIFY {
        time = '2 h'
        memory = '8 GB'
        cpus = params.threads
    }
    withName: REFERENCE_CHECK {
        time = '4 h'
        memory = '16 GB'
        cpus = params.threads
    }
    withName: PLOT {
        time = '1 h'
        memory = '4 GB'
        cpus = 1
    }
    withName: 'SC_.*' {
        time = '4 h'
        memory = '8 GB'
        cpus = params.threads
    }
}

profiles {
    local { executor = 'local' }

    // Docker: all processes (including PREPROCESS) run in the virall Docker image.
    // Work dirs are bind-mounted, so outputs persist on the host automatically.
    docker {
        docker.enabled = true
        docker.runOptions = '--entrypoint ""'
        process.container = 'pavle17/virall'
        process.containerOptions = {
            def opts = "-v ${task.workDir}:${task.workDir} -v ${task.workDir.parent.parent}:${task.workDir.parent.parent} -v ${task.workDir.parent.parent.parent}:${task.workDir.parent.parent.parent}"
            if (env.HOME) opts += " -v ${env.HOME}:${env.HOME}"
            return opts
        }
        params.kaiju_db = '/opt/virall/databases/kaiju_db'
        params.checkv_db = '/opt/virall/databases/checkv_db'
        params.genomad_db = '/opt/virall/databases/genomad_db'
        params.vog_db = '/opt/virall/databases/vog_db'
    }

    // Singularity: same DB location /opt/virall/databases/ (image includes tools + DBs).
    // Bind work dir and $HOME so staged files and paths like ~/analysis, outdir resolve.
    singularity {
        singularity.enabled = true
        process.container = "library://brupav/virall/virall:latest"
        process.containerOptions = {
            def opts = "-B ${task.workDir.parent.parent}:${task.workDir.parent.parent}"
            if (env.HOME) opts += " -B ${env.HOME}:${env.HOME}"
            return opts
        }
        params.kaiju_db = '/opt/virall/databases/kaiju_db'
        params.checkv_db = '/opt/virall/databases/checkv_db'
        params.genomad_db = '/opt/virall/databases/genomad_db'
        params.vog_db = '/opt/virall/databases/vog_db'
    }

    slurm {
        executor = 'slurm'
        queue = 'normal'
        clusterOptions = '-A your_account'
    }
    sge {
        executor = 'sge'
        queue = 'all.q'
    }
}
